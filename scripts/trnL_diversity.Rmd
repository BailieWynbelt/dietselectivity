---
title: "trnL_diversity"
author: "Bailie Wynbelt"
date: "2023-03-28"
output: html_document
---

#install tidyverse

```{r install packages}
library(tidyverse)
```

#load in ITS2 data

```{r read.csv}
reads_WTU_trnL <- read_csv("../data/updated_trnL_reads_WeeTU.csv")
```

#Remove plant voucher ids
```{r}
plants <- read_csv("../data/collection_data/vial_id.csv")

plants <- plants %>% 
  filter(sample_type == "plant") %>% 
  rename("SampleID" = vial_id) %>% 
  select(-sample_id)

no_millet_vouchers_trnL <- plants %>% 
  left_join(x = reads_WTU_trnL, by = "SampleID")

#count the number of rows with sample_type = plant
count_plants <- no_millet_vouchers_trnL %>% 
  filter(sample_type == "plant")

no_millet_vouchers_trnL <- no_millet_vouchers_trnL %>% 
  filter((sample_type != "plant") %>% 
  replace_na(TRUE))

write_csv(no_millet_vouchers_trnL, "../outputs/no_millet_vouchers_trnL.csv")
#It worked!
```

###Remove reads###
```{r}
under_10_reads_trnL <- no_millet_vouchers_trnL %>% 
  filter(Reads >= 10)

under_25_reads_trnL <- no_millet_vouchers_trnL %>% 
  filter(Reads >= 25)

under_50_reads_trnL <- no_millet_vouchers_trnL %>% 
  filter(Reads >= 50)
```

find max H value
```{r}
#ln of S, which = number of species in that community
#number of WTU.species (distinct)
distinct_species_10 <- under_10_reads_trnL  %>% 
  select(Species) %>%  
  distinct()
# = 431
distinct_species_25 <- under_25_reads_trnL  %>% 
  select(Species) %>%  
  distinct()
# = 293
distinct_species_50 <- under_50_reads_trnL  %>% 
  select(Species) %>%  
  distinct()
# = 213

trnl_species_10_h <- log(431)
trnl_species_25_h <- log(293)
trnl_species_50_h <- log(213)
```

###Diet Diversity###

#Find the sum of total reads
```{r}
under_10_reads_trnL <- under_10_reads_trnL %>% 
  group_by(SampleID) %>% 
  mutate(sum_reads_ID = sum(Reads))

under_25_reads_trnL <- under_25_reads_trnL %>% 
  group_by(SampleID) %>% 
  mutate(sum_reads_ID = sum(Reads))

under_50_reads_trnL <- under_50_reads_trnL %>% 
  group_by(SampleID) %>% 
  mutate(sum_reads_ID = sum(Reads))
```

#Find the proportion of species 
```{r}
under_10_reads_trnL <- under_10_reads_trnL %>% 
  group_by(SampleID) %>% 
  mutate(pI = (Reads/sum_reads_ID))

under_25_reads_trnL <- under_25_reads_trnL %>% 
  group_by(SampleID) %>% 
  mutate(pI = (Reads/sum_reads_ID))

under_50_reads_trnL <- under_50_reads_trnL %>% 
  group_by(SampleID) %>% 
  mutate(pI = (Reads/sum_reads_ID))
```

#Calculate the diversity index
```{r}
under_10_reads_trnL <- under_10_reads_trnL %>% 
  mutate(diversity_index = -sum(pI*log(pI))) 

under_25_reads_trnL <- under_25_reads_trnL %>% 
  mutate(diversity_index = -sum(pI*log(pI)))

under_50_reads_trnL <- under_50_reads_trnL %>% 
  mutate(diversity_index = -sum(pI*log(pI)))

```

#group by sampleid
```{r}
diversity_under_10 <- under_10_reads_trnL %>% 
  select(SampleID, sum_reads_ID, pI, diversity_index) %>% 
  distinct(SampleID, .keep_all = TRUE)

diversity_under_25 <- under_25_reads_trnL %>% 
  select(SampleID, sum_reads_ID, pI, diversity_index) %>% 
  distinct(SampleID, .keep_all = TRUE)

diversity_under_50 <- under_50_reads_trnL %>% 
  select(SampleID, sum_reads_ID, pI, diversity_index) %>% 
  distinct(SampleID, .keep_all = TRUE)
```

### Create synthesized csv's ###

#Join cutoff data frames
```{r}
joined_diversity <- diversity_under_10 %>% 
  left_join(diversity_under_25, by = "SampleID") %>% 
  rename("10_reads" = diversity_index.x,
         "25_reads" = diversity_index.y) %>% 
  select(-c(sum_reads_ID.x, pI.x, sum_reads_ID.y, pI.y))

joined_diversity <- joined_diversity %>% 
  left_join(diversity_under_50, by = "SampleID") %>% 
  rename("50_reads" = diversity_index) %>% 
  select(-c(pI, sum_reads_ID))

write_csv(joined_diversity, file = "../outputs/diversity_by_species_trnL.csv")

```

#Join cutoff data frames 2.0
```{r}
install.packages("reshape2") 
install.packages("reshape")
library(reshape)
library(reshape2)

diversity_long <- melt(joined_diversity,
                       id.vars = "SampleID",
                       variable.name = "cutoff",
                       value.name = "diversity_index")

write_csv(diversity_long, 
          file = "../outputs/diversity_by_species_trnL_long.csv")
```

### Visualize/understand ###

#Read_csv
```{r}
diversity <- read_csv("../outputs/diversity_by_species_trnL.csv")
diversity_long <- read_csv("../outputs/diversity_by_species_trnL_long.csv")
```

#Look at differences in cut-offs
```{r}
sum_diversity_species_trnL <- diversity_long %>% 
  group_by(cutoff) %>% 
  summarise(mean_diversity = mean(diversity_index, na.rm = TRUE),
            sd_diversity = sd(diversity_index, na.rm = TRUE))

```

#Look at ggplot
```{r}
ggplot(data = diversity_long, aes(x = diversity_index, color = cutoff, fill = cutoff)) +
  geom_histogram(alpha = 0.5)

```

#Run stats - is there a statistical differenece
```{r}
#what is the best to run??
diversity_anova <- aov(diversity_index ~ cutoff, data = diversity_long)
summary(diversity_anova)
TukeyHSD(diversity_anova)
```